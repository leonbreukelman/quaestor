# Feature Specification: QuaestorInvestigator DSPy Module for Adaptive Conversational Probing

**Generated**: 2026-01-14T17:24:01.874572
**Status**: Draft
**Source**: Auto-generated by Smactorio workflow

---

## Overview

The QuaestorInvestigator is a DSPy-based module that enables multi-turn adaptive conversational probing of AI agents. It dynamically determines probe strategies based on conversation history, supports various probe types (positive, adversarial, edge case), and integrates with TargetAdapter for seamless agent communication while providing graceful degradation on adapter failures.

## Problem Statement

Testing and evaluating AI agents requires sophisticated multi-turn conversational probing that adapts based on agent responses. Currently, there is no standardized module for conducting adaptive investigations that can track probe history, vary probe strategies, and handle communication failures gracefully. This creates challenges in systematically evaluating agent behavior across different scenarios.

---

## User Stories

### US1 - Determine Next Probe Strategy (Priority: P0)

As a **AI evaluation engineer**, I want to **use ProbeStrategySignature to determine the next probe based on conversation history**, so that **I can adaptively probe agents with contextually appropriate questions that build on previous interactions**.

**Independent Test**: Given a conversation history with 3 exchanges, when ProbeStrategySignature is invoked, then it returns a valid probe recommendation that references context from the history

**Acceptance Criteria**:

1. ProbeStrategySignature accepts conversation history as input
2. ProbeStrategySignature outputs a structured probe recommendation
3. The signature considers previous probes and responses when recommending next probe
4. The signature can be used with dspy.ChainOfThought for reasoning

### US2 - Initialize QuaestorInvestigator Module (Priority: P0)

As a **developer**, I want to **instantiate a QuaestorInvestigator class that uses dspy.ChainOfThought**, so that **I can create investigation sessions with built-in reasoning capabilities for probe generation**.

**Independent Test**: When QuaestorInvestigator is instantiated with a mock TargetAdapter, then it initializes successfully and has a ChainOfThought predictor available

**Acceptance Criteria**:

1. QuaestorInvestigator class can be instantiated with configuration parameters
2. The class internally uses dspy.ChainOfThought with ProbeStrategySignature
3. The class accepts a TargetAdapter for agent communication
4. Default configuration values are provided for optional parameters

### US3 - Conduct Adaptive Probing Session (Priority: P0)

As a **AI evaluation engineer**, I want to **run an adaptive probing session that collects observations from agent responses**, so that **I can systematically investigate agent behavior through multi-turn conversations while gathering structured observations**.

**Independent Test**: Given a QuaestorInvestigator with a mock adapter returning predefined responses, when a 5-turn probing session is run, then all 5 exchanges are recorded with corresponding observations

**Acceptance Criteria**:

1. Method accepts initial context and maximum number of turns
2. Each turn generates a probe, sends it via TargetAdapter, and records the response
3. Observations are collected and structured after each agent response
4. Session terminates when max turns reached or termination criteria met
5. Returns complete session results including all probes, responses, and observations

### US4 - Track Probe History (Priority: P1)

As a **AI evaluation engineer**, I want to **access and query the complete probe history during and after an investigation**, so that **I can analyze the progression of the conversation and review all probes and responses for evaluation**.

**Independent Test**: After running a 3-turn session with mixed probe types, when ProbeHistory is queried by probe type, then it correctly filters and returns only matching entries

**Acceptance Criteria**:

1. ProbeHistory class stores all probes with timestamps
2. ProbeHistory stores all agent responses with timestamps
3. ProbeHistory supports querying by probe type
4. ProbeHistory supports querying by turn number
5. History is accessible during active sessions and after completion

### US5 - Support Multiple Probe Types (Priority: P1)

As a **AI evaluation engineer**, I want to **configure and use different probe types including positive, adversarial, and edge case probes**, so that **I can comprehensively evaluate agent behavior across various interaction scenarios**.

**Independent Test**: When a session is configured with 50% adversarial probe preference, then at least 40% of generated probes are tagged as ADVERSARIAL type

**Acceptance Criteria**:

1. Probe type enumeration includes POSITIVE, ADVERSARIAL, and EDGE_CASE
2. ProbeStrategySignature can be configured to prefer certain probe types
3. Each probe in history is tagged with its type
4. Probe type distribution can be configured per session
5. Custom probe types can be added via extension

### US6 - Integrate with TargetAdapter (Priority: P0)

As a **developer**, I want to **connect QuaestorInvestigator to any AI agent via the TargetAdapter interface**, so that **I can probe different types of AI agents without modifying the investigation logic**.

**Independent Test**: Given two different TargetAdapter implementations (mock HTTP and mock WebSocket), when the same investigation is run with each, then both complete successfully with adapter-specific communication

**Acceptance Criteria**:

1. QuaestorInvestigator accepts any TargetAdapter implementation
2. Probes are sent through the adapter's communication method
3. Responses are received through the adapter's response handling
4. Adapter configuration is separate from investigator configuration
5. Multiple adapter types can be swapped without code changes

### US7 - Handle Adapter Failures Gracefully (Priority: P1)

As a **AI evaluation engineer**, I want to **continue investigation sessions even when the TargetAdapter encounters failures**, so that **I can complete evaluations without losing progress due to transient communication issues**.

**Independent Test**: Given an adapter configured to fail on the 3rd request, when a 5-turn session is run with retry count of 2, then the session completes with the 3rd probe marked as failed and turns 4-5 executed successfully

**Acceptance Criteria**:

1. Adapter timeouts are caught and logged without crashing
2. Adapter connection errors trigger configurable retry logic
3. Failed probes are marked in history with failure reason
4. Session can continue after configurable number of consecutive failures
5. Session terminates gracefully if failure threshold exceeded
6. Partial results are preserved and returned on early termination

### US8 - Configure Investigation Parameters (Priority: P2)

As a **developer**, I want to **configure investigation parameters such as max turns, probe type weights, and termination criteria**, so that **I can customize investigation behavior for different evaluation scenarios**.

**Independent Test**: When QuaestorInvestigator is configured with max_turns=3 and a custom termination criterion that triggers on keyword 'STOP', then session ends at turn 2 if agent responds with 'STOP' at turn 2

**Acceptance Criteria**:

1. Max turns parameter limits session length
2. Probe type weight parameters influence strategy selection
3. Custom termination criteria can be provided as callable
4. Timeout parameters control individual probe wait times
5. All parameters have sensible defaults following safety-by-default principle

---

## Entities

### ProbeStrategySignature
**Type**: entity
**Description**: DSPy signature defining inputs and outputs for probe strategy determination
**Attributes**:
  - conversation_history
  - probe_type_preferences
  - investigation_context

### QuaestorInvestigator
**Type**: entity
**Description**: Main DSPy module class for conducting adaptive investigations
**Attributes**:
  - target_adapter
  - chain_of_thought_predictor
  - probe_history
  - configuration

### ProbeHistory
**Type**: entity
**Description**: Container for tracking all probes and responses during investigation
**Attributes**:
  - entries
  - start_time
  - session_id

### ProbeEntry
**Type**: entity
**Description**: Single entry in probe history representing one exchange
**Attributes**:
  - turn_number
  - probe_text
  - probe_type
  - response_text
  - timestamp
  - observations
  - status

### ProbeType
**Type**: entity
**Description**: Enumeration of supported probe types

### TargetAdapter
**Type**: entity
**Description**: Interface for communicating with target AI agents

## Functional Requirements

FR-001: FR-001: ProbeStrategySignature MUST accept conversation history and return structured probe recommendation
FR-002: FR-002: QuaestorInvestigator MUST use dspy.ChainOfThought with ProbeStrategySignature for probe generation
FR-003: FR-003: QuaestorInvestigator MUST integrate with TargetAdapter interface for agent communication
FR-004: FR-004: ProbeHistory MUST track all probes, responses, and observations with timestamps
FR-005: FR-005: System MUST support POSITIVE, ADVERSARIAL, and EDGE_CASE probe types
FR-006: FR-006: System MUST provide graceful degradation when TargetAdapter fails
FR-007: FR-007: Investigation sessions MUST be configurable with max turns and termination criteria
FR-008: FR-008: Each probe MUST be tagged with its probe type in history
FR-009: FR-009: Observations MUST be collected and structured after each agent response
FR-010: FR-010: Partial results MUST be preserved and returned on early session termination

## Non-Functional Requirements

NFR-001: NFR-001: Adapter failures MUST NOT crash the investigation session
NFR-002: NFR-002: All public APIs MUST have contract tests before implementation (per TDD principle)
NFR-003: NFR-003: Default behaviors MUST be non-destructive (per safety-by-default principle)
NFR-004: NFR-004: Configuration parameters MUST have sensible safe defaults
NFR-005: NFR-005: Module MUST be compatible with DSPy framework patterns and conventions

## Business Rules

- BR-001: Investigation sessions terminate when max turns reached OR termination criteria met
- BR-002: Sessions terminate gracefully if consecutive failure threshold exceeded
- BR-003: Failed probes are marked but do not count toward successful turn count
- BR-004: Probe type distribution should approximate configured weights over sufficient turns

## Assumptions

- DSPy framework is available and properly configured in the runtime environment
- TargetAdapter interface is already defined elsewhere in the codebase
- LLM backend is configured for DSPy ChainOfThought operations
- Conversation history format is compatible with DSPy signature requirements

## Open Questions

- [ ] What is the exact interface contract for TargetAdapter that must be supported?
- [ ] Should ProbeHistory support persistence to disk or database?
- [ ] What metrics should be collected for observation analysis?
- [ ] Should there be a callback mechanism for real-time monitoring of investigation progress?
- [ ] What is the expected latency tolerance for adapter communication?

## Success Criteria

- All 8 user stories pass acceptance criteria with automated tests
- QuaestorInvestigator can complete a 10-turn investigation session with mock adapter
- Graceful degradation verified with adapter failure injection tests
- All three probe types (positive, adversarial, edge case) can be generated and tracked
- ProbeHistory correctly filters and queries entries by type and turn number
- Integration tests pass with at least one real TargetAdapter implementation
- Contract tests exist for all public APIs before implementation (TDD compliance)
- Default configuration is safe and non-destructive (safety-by-default compliance)
